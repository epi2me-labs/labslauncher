#:import Factory kivy.factory.Factory
#: import join os.path.join
#: import isdir os.path.isdir
#: import filename pkg_resources.resource_filename
#: import icon kivy.garden.iconfonts.icon

<Copypopup@Popup>:
    auto_dismiss: True
    title: "Copied to clipboard"
    size_hint: 0.8, 0.6
    Label:
        text_size: self.size
        valign: 'top'
        text: "The server address has been copied to your clipboard, it can now be used in your web browser to connect Colab to your notebook server. See the Welcome page for more details."

<DatapathHelp@Popup>:
    auto_dismiss: True
    title: "Data path"
    size_hint: 0.8, 0.6
    Label:
        text_size: self.size
        valign: 'top'
        text: "The data path is the location on your computer you wish to be readable (and writeable) within the notebook environment. It will be available in the environment under `/epi2melabs`."

<TokenHelp@Popup>:
    auto_dismiss: True
    title: "Secret token"
    size_hint: 0.8, 0.6
    Label:
        text_size: self.size
        valign: 'top'
        text: "A secret token used to connect to the notebook server. Anyone with this token will be able to connect to the server, and therefore modify files under the data location."

<PortHelp@Popup>:
    auto_dismiss: True
    title: "Network Port"
    size_hint: 0.8, 0.6
    Label:
        text_size: self.size
        valign: 'top'
        text: "The network port to used to communicate between web-browser and notebook server."

<OurButton@Button>:
    size: 100, 40
    size_hint: None, None
<OurLabel@Label>:
    size: root.width, 30
    #size_hint: None, None
<ButtonRow@BoxLayout>
    size: root.width, 40
    size_hint_y: None

<HomeScreen>:
    id: home_screen
    containerlbl: containerlbl
    startbtn: startbtn
    stopbtn: stopbtn
    addrbtn: addrbtn
    BoxLayout:
        orientation: "vertical"
        AnchorLayout:
            anchor_x: 'center'
            anchor_y: 'center'
            Image:
                source: filename("labslauncher", "EPI2ME_labs_logo_RGB_negative_large.png")
                size: 150, 100
                size_hint: 0.9, 0.9
                keep_ratio: True
                allow_stretch: False
        ButtonRow:
            Label:
                # just to pad
            OurButton:
                id: startbtn
                text: "Start"
                on_release:
                    if app.docker_is_running: root.goto_start_settings()
                    else: app.docker_not_running_popup()
            OurButton:
                id: stopbtn
                text: "Stop"
                on_release:
                    if app.docker_is_running: app.clear_container()
                    else: app.docker_not_running_popup()
            Label:
                # just to pad
        BoxLayout:
            size: root.width, 30
            size_hint: None, None
            OurLabel:
                id: containerlbl
                text: "Server status:"
        BoxLayout:
            size: root.width, 30
            size_hint: None, None
            OurLabel:
                id: addrbtn
                text: root.address_fmt
                markup: True
                on_ref_press: root.copy_address_to_clip(), Factory.Copypopup().open()
        BoxLayout:
            size: root.width, 30
            size_hint: None, None
            OurLabel:
                text: "Navigate to the [color=2a7cdf][ref=click]Welcome page[/ref][/color] to get started."
                markup: True
                on_ref_press: root.open_colab()

<StartScreen>:
    id: start_screen
    containerlbl: containerlbl
    datamount_input: datamount_input
    token_input: token_input
    port_input: port_input
    startbtn: startbtn
    updatebtn: updatebtn
    backbtn: backbtn
    BoxLayout:
        orientation: "vertical"
        ButtonRow:
            OurLabel:
                id: containerlbl
                text: "Start server"
        ButtonRow:
            Label:
            OurButton:
                id: datamount_input
                text: 'Select path'
                on_release: root.show_load()
            TextInput:
                size: root.width / 2, 40
                size_hint: None, None
                id: datamount_input
                text: root.chosen_path
                disabled: True
            Label:
                size: 30, 40
                size_hint: None, None
                text: "[ref=click]{}[/ref]".format(icon('fa-info-circle'))
                markup: True
                on_ref_press: Factory.DatapathHelp().open()
            Label:
        ButtonRow:
            Label:
            Label:
                size: 100, 40
                size_hint: None, None
                text_size: self.size
                halign: 'right'
                valign: 'center'
                text: "token:"
            TextInput:
                id: token_input
                size: root.width / 2, 40
                size_hint: None, None
                multiline: False
                input_filter: lambda token, from_undo: token[:10 - len(self.text)]
                on_text_validate: port_input.focus = True
                text: app.conf.LABSTOKEN
            Label:
                size: 30, 40
                size_hint: None, None
                text: "[ref=click]{}[/ref]".format(icon('fa-info-circle'))
                markup: True
                on_ref_press: Factory.TokenHelp().open()
            Label:
        ButtonRow:
            Label:
            Label:
                size: 100, 40
                size_hint: None, None
                text_size: self.size
                halign: 'right'
                valign: 'center'
                text: "port:"
            TextInput:
                id: port_input
                size: root.width / 2, 40
                size_hint: None, None
                multiline: False
                input_filter: "int"
                text: str(app.conf.PORTHOST)
            Label:
                size: 30, 40
                size_hint: None, None
                text: "[ref=click]{}[/ref]".format(icon('fa-info-circle'))
                markup: True
                on_ref_press: Factory.PortHelp().open()
            Label:
        Label:
        ButtonRow:
            Label:
            OurButton:
                id: startbtn
                text: "Start"
                on_release:
                    if app.docker_is_running: root.start_server()
                    else: app.docker_not_running_popup()
            OurButton:
                id: updatebtn
                text: "Update"
                on_release:
                    if app.docker_is_running: root.update_server()
                    else: app.docker_not_running_popup()
                disabled: not app.can_update
            OurButton:
                id: backbtn
                text: "Back"
                on_release: root.goto_home()
            Label:


<LoadDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            dirselect: True
            filters: [lambda x,y: isdir(join(x,y))]
        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)
            Button:
                text: "Cancel"
                on_release: root.cancel()
